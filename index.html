<!-- âŒ ELIMINADO TODO LO DEL SHADOW DOM -->
<!-- NO app-root, NO attachShadow, NO mover body -->

<script src="sentences.js"></script>

<script>
// ================= DOM =================
const startScreen = document.getElementById("startScreen");
const gameScreen = document.getElementById("gameScreen");
const startBtn = document.getElementById("startBtn");

const playerName = document.getElementById("playerName");
const playerLabel = document.getElementById("playerLabel");

const sentence = document.getElementById("sentence");
const activityLabel = document.getElementById("activityLabel");
const modeInstructions = document.getElementById("modeInstructions");

const choices = document.getElementById("choices");
const wordbank = document.getElementById("wordbank");
const answer = document.getElementById("answer");

const checkBtn = document.getElementById("checkBtn");
const undoBtn = document.getElementById("undoBtn");
const feedback = document.getElementById("feedback");

const progressBar = document.getElementById("progressBar");
const streakSpan = document.getElementById("streak");
const mistakesSpan = document.getElementById("mistakes");

const pauseBtn = document.getElementById("pauseBtn");
const resetBtn = document.getElementById("resetBtn");
const pauseOverlay = document.getElementById("pauseOverlay");
const continueBtn = document.getElementById("continueBtn");
const musicBtn = document.getElementById("musicBtn");

// ================= STATE =================
let streak = 0;
let mistakes = 0;
let current;
let selectedWords = [];

const shuffle = arr => [...arr].sort(() => Math.random() - 0.5);

// ================= START =================
startBtn.onclick = () => {
  const name = playerName.value.trim();
  if (!name) return;

  playerLabel.textContent = "ðŸ‘¤ " + name;
  startScreen.classList.add("hidden");
  gameScreen.classList.remove("hidden");

  streak = 0;
  mistakes = 0;
  updateStats();
  next();
};

// ================= GAME FLOW =================
function next() {
  if (!window.BANK || BANK.length === 0) {
    alert("Sentence bank not loaded");
    return;
  }

  if (streak >= 25) {
    document.querySelector(".game").innerHTML =
      `<div class="feedback ok">ðŸŽ‰ CHALLENGE COMPLETE!</div>`;
    return;
  }

  current = shuffle(BANK)[0];
  selectedWords = [];

  sentence.textContent = current.t;
  activityLabel.textContent = current.type.toUpperCase();

  choices.innerHTML = "";
  wordbank.innerHTML = "";
  answer.textContent = "";
  feedback.classList.add("hidden");

  if (current.type === "choose") renderChoose();
  else renderOrder();
}

// ================= MODES =================
function renderChoose() {
  choices.classList.remove("hidden");
  wordbank.classList.add("hidden");
  answer.classList.add("hidden");
  checkBtn.classList.add("hidden");
  undoBtn.classList.add("hidden");

  shuffle(current.opts).forEach(opt => {
    const d = document.createElement("div");
    d.className = "choice";
    d.textContent = opt;
    d.onclick = () => check(opt);
    choices.appendChild(d);
  });
}

function renderOrder() {
  choices.classList.add("hidden");
  wordbank.classList.remove("hidden");
  answer.classList.remove("hidden");
  checkBtn.classList.remove("hidden");
  undoBtn.classList.remove("hidden");

  shuffle(current.a.split(" ")).forEach(word => {
    const w = document.createElement("div");
    w.className = "word";
    w.textContent = word;
    w.onclick = () => {
      if (w.classList.contains("used")) return;
      w.classList.add("used");
      selectedWords.push(word);
      answer.textContent = selectedWords.join(" ");
    };
    wordbank.appendChild(w);
  });
}

// ================= CHECK =================
checkBtn.onclick = () => check(answer.textContent);

function check(value) {
  feedback.classList.remove("hidden");

  if (value === current.a) {
    streak++;
    feedback.textContent = "âœ” Correct!";
    feedback.className = "feedback ok";
  } else {
    streak = 0;
    mistakes++;
    feedback.textContent = `âœ˜ ${current.a}`;
    feedback.className = "feedback no";
  }

  updateStats();
  setTimeout(next, 1200);
}

// ================= HELPERS =================
function updateStats() {
  streakSpan.textContent = streak;
  mistakesSpan.textContent = mistakes;
  progressBar.style.width = (streak / 25 * 100) + "%";
}

// ================= RESET =================
resetBtn.onclick = () => {
  streak = 0;
  mistakes = 0;
  updateStats();
  next();
};
</script>
